name: Build cpuminer-opt (Windows x86_64)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install MSYS2 and dependencies
      run: |
        # Download and install MSYS2
        Invoke-WebRequest -Uri "https://github.com/msys2/msys2-installer/releases/download/2025-06-22/msys2-x86_64-20250622.exe" -OutFile msys2-setup.exe
        Start-Process -FilePath .\msys2-setup.exe -ArgumentList "install --root C:\msys64 --confirm-command" -Wait -NoNewWindow
        
        # Update packages and install required components
        C:\msys64\usr\bin\bash.exe -lc "pacman --noconfirm -Syuu"
        C:\msys64\usr\bin\bash.exe -lc "pacman --noconfirm -S mingw-w64-x86_64-toolchain autotools mingw-w64-x86_64-curl mingw-w64-x86_64-gmp mingw-w64-x86_64-jansson mingw-w64-x86_64-zlib"

    - name: Build cpuminer-opt
      run: |
        # Добавляем MSYS2 в PATH
        echo "C:\msys64\mingw64\bin" >> $GITHUB_PATH
        
        # Конвертируем Windows-путь в UNIX-формат для MSYS2
        $unixPath = $PWD.Path.Replace('\', '/').Replace('C:', '/c')
        Write-Output "Converted path: $unixPath"
        
        # Запускаем сборку в MSYS2
        C:\msys64\usr\bin\bash.exe -lc "
          cd '$unixPath' &&
          ./autogen.sh &&
          CFLAGS='-O3 -march=znver2 -msse4.2 -maes' ./configure --host=x86_64-w64-mingw32 &&
          make -j$(nproc)
        "

    - name: Prepare artifact
      run: |
        # Create artifact directory
        mkdir artifact
        cp cpuminer.exe artifact/
        
        # Copy required DLLs
        cp /c/msys64/mingw64/bin/libcurl-4.dll artifact/
        cp /c/msys64/mingw64/bin/libgmp-10.dll artifact/
        cp /c/msys64/mingw64/bin/libwinpthread-1.dll artifact/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: miner-package
        path: artifact/
        retention-days: 1  # Автоматическое удаление через 1 день
