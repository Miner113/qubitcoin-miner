name: Build cpuminer-opt (Windows x86_64)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install MSYS2 and dependencies
      run: |
        # Установка MSYS2
        Invoke-WebRequest -Uri "https://github.com/msys2/msys2-installer/releases/download/2025-06-22/msys2-x86_64-20250622.exe" -OutFile msys2-setup.exe
        Start-Process -FilePath .\msys2-setup.exe -ArgumentList "install --root C:\msys64 --confirm-command" -Wait -NoNewWindow
        
        # Обновление пакетов и установка компилятора
        C:\msys64\usr\bin\bash.exe -lc "
          pacman --noconfirm -Syuu
          pacman --noconfirm -S mingw-w64-x86_64-toolchain
          pacman --noconfirm -S autotools
          pacman --noconfirm -S mingw-w64-x86_64-curl
          pacman --noconfirm -S mingw-w64-x86_64-gmp
          pacman --noconfirm -S mingw-w64-x86_64-jansson
          pacman --noconfirm -S mingw-w64-x86_64-zlib
        "

    - name: Set up environment
      run: |
        # Добавляем MinGW в PATH
        echo "C:\msys64\mingw64\bin" >> $GITHUB_PATH
        echo "C:\msys64\usr\bin" >> $GITHUB_PATH

    - name: Build cpuminer-opt
      shell: bash
      run: |
        # Проверка доступности компилятора
        which gcc
        gcc --version
        
        # Сборка проекта
        ./autogen.sh
        CFLAGS='-O3 -march=znver2 -msse4.2 -maes' ./configure --host=x86_64-w64-mingw32
        make -j$(nproc)

    - name: Prepare artifact
      run: |
        mkdir artifact
        cp cpuminer.exe artifact/
        cp /c/msys64/mingw64/bin/lib*.dll artifact/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: miner-package
        path: artifact/
